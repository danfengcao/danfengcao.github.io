## 大批量清除数据

### 基本思想

> 批量、间隔操作

#### 法一：用oak-chunk-update搞定
 > 使用oak-chunk-update需要有**自增id**。注意条件字段必须有索引！
 
 > [oak-chunk-update](http://code.openark.org/forge/openark-kit): perform long, non-blocking UPDATE/DELETE operation in auto managed small chunks.
 
 > oak-chunk-update --user=myadmin  --password='passwd' --host=10.1.6.195 --port=3306  --database=zabbix --execute="DELETE FROM history WHERE clock < unix_timestamp('2015-07-01') and OAK_CHUNK(history)" --chunk-size=30000 --sleep=100 --skip-lock-tables -v
 
> 注：此法不会立即释放磁盘空间，但新插入数据将填补空缺，磁盘空间不会再增长。
> 释放空间需要整理碎片(锁表时间会很长)；

#### 法二：保留需要数据到新表，删除老表

1. 建立新表 
> CREATE TABLE new_tbl LIKE tbl;

2. 在原有表自增ID基础上加上一个值；
> alter table new_tbl AUTO_INCREMENT=增加后的值;

3. 重命名两张表
> 同时重命名两张表，间接实现数据删除操作；
> 
> RENAME TABLE tbl TO old_tbl, new_tbl TO tbl; 

4. 保留所需数据 
> 若数据量不大，可直接插入。 
> 
> INSERT INTO new_tbl SELECT * FROM tbl WHERE ID >= 1000000; 
>
> 若数据量大，须分批缓慢导入到新表。(此步看情况，有些情况会麻烦些)

5. 观察一段时间后，删除原表
> DROP TABLE old_tbl;

